<%- include('partials/header', { title: 'Order Confirmed | Certified Mail Sender' }) %>

<main id="main">

<% if (typeof pending !== 'undefined' && pending) { %>
  <div class="order-status-banner processing" id="pending-banner">
    <div class="status-icon spinning"><svg class="icon" style="width:2.5rem;height:2.5rem" aria-hidden="true"><use href="#icon-mail"/></svg></div>
    <h2>Processing Your Order&hellip;</h2>
    <p>Your payment was received. We're setting up your certified letter now. This page will update automatically.</p>
  </div>
  <div class="order-status-banner info" id="timeout-banner" style="display:none">
    <div class="status-icon"><svg class="icon" style="width:2.5rem;height:2.5rem" aria-hidden="true"><use href="#icon-check-circle"/></svg></div>
    <h2>Payment Received</h2>
    <p>Your order is being processed. You will receive an email with your tracking number and order details shortly. You can close this page.</p>
  </div>
  <script>
  (function(){
    var attempts=0, maxAttempts=20, delay=3000;
    function poll(){
      if(attempts>=maxAttempts){
        document.getElementById('pending-banner').style.display='none';
        document.getElementById('timeout-banner').style.display='';
        return;
      }
      attempts++;
      setTimeout(function(){ window.location.reload(); }, delay);
      if(attempts>5) delay=5000;
    }
    poll();
  })();
  </script>

<% } else if (!order) { %>
  <div class="order-status-banner success">
    <div class="status-icon"><svg class="icon" style="width:2.5rem;height:2.5rem" aria-hidden="true"><use href="#icon-check-circle"/></svg></div>
    <h2>Payment Received</h2>
    <p>Your certified letter is being processed. You will receive an email with your USPS tracking number and delivery details shortly.</p>
  </div>

  <div class="what-to-expect-box">
    <h3 class="what-to-expect-title">
      <svg class="icon" aria-hidden="true"><use href="#icon-envelope-check"/></svg>
      What To Expect
    </h3>
    <ul class="expect-list">
      <li>Check your email for your tracking number and order confirmation</li>
      <li>Your Proof of Acceptance PDF will be available within hours of USPS acceptance</li>
      <li>Track your letter anytime on USPS.com or your tracking page</li>
      <li>All official documents stored for 10 years</li>
    </ul>
  </div>

  <div style="margin-top:1rem;text-align:center"><a href="/">Send another letter</a></div>

<% } else { %>
  <div class="order-status-banner success">
    <div class="status-icon"><svg class="icon" style="width:2.5rem;height:2.5rem" aria-hidden="true"><use href="#icon-check-circle"/></svg></div>
    <h2>Order Confirmed</h2>
    <p>Your certified letter has been submitted to USPS. An email with your tracking number has been sent to <strong><%= order.customer_email %></strong>.</p>
  </div>

  <div class="verified-transaction">
    <svg class="icon" aria-hidden="true"><use href="#icon-shield"/></svg>
    Verified Secure Transaction
  </div>

  <div class="order-details-grid">
    <div class="order-detail-card">
      <div class="detail-label">From</div>
      <div class="detail-value"><%= order.sender_name %></div>
      <div class="detail-sub"><%= order.sender_address %></div>
    </div>
    <div class="order-detail-card">
      <div class="detail-label">To</div>
      <div class="detail-value"><%= order.recipient_name %></div>
      <div class="detail-sub"><%= order.recipient_address %></div>
    </div>
  </div>

  <% if (googleMapsKey && order.recipient_address) { %>
  <div class="map-container">
    <img
      src="https://maps.googleapis.com/maps/api/staticmap?center=<%= encodeURIComponent(order.recipient_address) %>&zoom=14&size=600x200&scale=2&markers=color:red|<%= encodeURIComponent(order.recipient_address) %>&key=<%= googleMapsKey %>"
      alt="Recipient location map"
      class="static-map"
      loading="lazy"
    >
  </div>
  <% } %>

  <% if (order.tracking_number) { %>
  <div class="usps-tracking-card">
    <div class="tracking-header">
      <svg class="icon" aria-hidden="true"><use href="#icon-eagle"/></svg>
      USPS Tracking
    </div>
    <div class="tracking-number"><%= order.tracking_number %></div>
    <a href="https://tools.usps.com/go/TrackConfirmAction?tLabels=<%= order.tracking_number %>" target="_blank" rel="noopener" class="track-button">
      <svg class="icon" aria-hidden="true"><use href="#icon-eagle"/></svg>
      Track on USPS.com
    </a>
  </div>
  <% } %>

  <div class="order-info-section">
    <div class="info-row">
      <span class="info-label">Tracking Number</span>
      <span class="info-value">
        <% if (order.tracking_number) { %>
          <a href="https://tools.usps.com/go/TrackConfirmAction?tLabels=<%= order.tracking_number %>" target="_blank" rel="noopener"><%= order.tracking_number %></a>
        <% } else { %>
          <span class="text-muted">Assigning&hellip;</span>
        <% } %>
      </span>
    </div>
    <div class="info-row">
      <span class="info-label">Service</span>
      <span class="info-value">
        <span class="usps-badge" style="font-size:.6rem;padding:.2rem .5rem">
          <svg class="icon" aria-hidden="true"><use href="#icon-eagle"/></svg>
          USPS Certified Mail<%= order.return_receipt ? ' + Return Receipt' : '' %>
        </span>
      </span>
    </div>
    <div class="info-row">
      <span class="info-label">Amount Paid</span>
      <span class="info-value">$<%= (order.amount_cents / 100).toFixed(2) %></span>
    </div>
    <div class="info-row">
      <span class="info-label">Status</span>
      <span class="info-value">
        <span class="status-badge status-<%= order.delivery_status || 'processing' %>">
          <%= (order.delivery_status || 'processing').replace(/_/g, ' ') %>
        </span>
      </span>
    </div>
  </div>

  <div class="what-to-expect-box">
    <h3 class="what-to-expect-title">
      <svg class="icon" aria-hidden="true"><use href="#icon-envelope-check"/></svg>
      What To Expect
    </h3>
    <ul class="expect-list">
      <li>Your Proof of Acceptance PDF will be available within hours of USPS acceptance</li>
      <li>Your Proof of Delivery PDF will be available within hours of delivery</li>
      <% if (order.return_receipt) { %><li>Your Return Receipt (signed by recipient) will be available within 24 hours of delivery</li><% } %>
      <li>Track your letter anytime on USPS.com or from the link below</li>
      <li>All official documents stored for 10 years and downloadable from your tracking page</li>
    </ul>
  </div>

  <% if (order.order_token) { %>
  <div class="tracking-link-box">
    <p><strong>Bookmark this link to track your letter and download official documents:</strong></p>
    <a href="/order/<%= order.order_token %>" class="magic-link">/order/<%= order.order_token %></a>
    <p class="text-muted" style="margin-top:.5rem;font-size:.85rem">This link has also been sent to <strong><%= order.customer_email %></strong></p>
  </div>
  <% } %>

  <% if (!order.phone_number) { %>
  <div class="add-info-section">
    <form action="/order/<%= order.order_token %>/phone" method="POST" class="inline-form">
      <input type="hidden" name="_csrf" value="<%= csrfToken %>">
      <label for="phone_number">Add Phone Number <span class="optional-tag">(optional)</span></label>
      <div class="inline-form-row">
        <input type="tel" id="phone_number" name="phone_number" placeholder="(555) 123-4567" pattern="[\d\s\-\(\)\+]+" required>
        <button type="submit">Save</button>
      </div>
    </form>
  </div>
  <% } %>

  <div style="margin-top:1.5rem;text-align:center">
    <a href="/" class="cta-button">Send Another Letter</a>
  </div>
<% } %>

<%- include('partials/footer') %>
